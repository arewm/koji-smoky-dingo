
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="English">
  <head>
    <meta charset="utf-8" />
    <title>kojismokydingo.builds &#8212; kojismokydingo 0.9.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/pyramid.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex/" />
    <link rel="search" title="Search" href="../../../search/" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Neuton&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nobile:regular,italic,bold,bolditalic&amp;subset=latin" type="text/css" media="screen" charset="utf-8" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

  </head><body>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../">kojismokydingo 0.9.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../" accesskey="U">kojismokydingo</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for kojismokydingo.builds</h1><div class="highlight"><pre>
<span></span><span class="c1"># This library is free software; you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU General Public License as published by</span>
<span class="c1"># the Free Software Foundation; either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># This library is distributed in the hope that it will be useful, but</span>
<span class="c1"># WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="c1"># General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU General Public License</span>
<span class="c1"># along with this library; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Koji Smoky Dingo - Build Utilities</span>

<span class="sd">Functions for working with Koji builds</span>

<span class="sd">:author: Christopher O&#39;Brien &lt;obriencj@gmail.com&gt;</span>
<span class="sd">:license: GPL v3</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">itervalues</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">bulk_load_build_archives</span><span class="p">,</span> <span class="n">bulk_load_builds</span><span class="p">,</span>
    <span class="n">bulk_load_buildroots</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">.common</span> <span class="k">import</span> <span class="n">chunkseq</span><span class="p">,</span> <span class="n">rpm_evr_compare</span><span class="p">,</span> <span class="n">unique</span>


<div class="viewcode-block" id="BuildNEVRCompare"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.BuildNEVRCompare">[docs]</a><span class="k">class</span> <span class="nc">BuildNEVRCompare</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An adapter for Name, Epoch, Version, Release comparisons of a</span>
<span class="sd">    build info dictionary. Used by the nevr_sort_builds function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binfo</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build</span> <span class="o">=</span> <span class="n">binfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">binfo</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

        <span class="n">evr</span> <span class="o">=</span> <span class="p">(</span><span class="n">binfo</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">],</span> <span class="n">binfo</span><span class="p">[</span><span class="s2">&quot;version&quot;</span><span class="p">],</span> <span class="n">binfo</span><span class="p">[</span><span class="s2">&quot;release&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evr</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="s2">&quot;0&quot;</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">evr</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__cmp__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="c1"># cmp is a python2-ism, and has no replacement in python3 via</span>
        <span class="c1"># six, so we&#39;ll have to create our own simplistic behavior</span>
        <span class="c1"># similarly</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rpm_evr_compare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evr</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">evr</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>


    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>


    <span class="k">def</span> <span class="nf">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__cmp__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="build_nvr_sort"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.build_nvr_sort">[docs]</a><span class="k">def</span> <span class="nf">build_nvr_sort</span><span class="p">(</span><span class="n">build_infos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a sequence of build info dictionaries, deduplicate and then</span>
<span class="sd">    sort them by Name, Epoch, Version, and Release using RPM&#39;s</span>
<span class="sd">    variation of comparison</span>

<span class="sd">    :param build_infos: build infos to be sorted and de-duplicated</span>
<span class="sd">    :type build_infos: list[dict]</span>

<span class="sd">    :rtype: list[dict]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dedup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">build_infos</span> <span class="k">if</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">itervalues</span><span class="p">(</span><span class="n">dedup</span><span class="p">),</span> <span class="n">key</span><span class="o">=</span><span class="n">BuildNEVRCompare</span><span class="p">)</span></div>


<div class="viewcode-block" id="build_id_sort"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.build_id_sort">[docs]</a><span class="k">def</span> <span class="nf">build_id_sort</span><span class="p">(</span><span class="n">build_infos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a sequence of build info dictionaries, return a de-duplicated</span>
<span class="sd">    list of same, sorted by the build ID</span>

<span class="sd">    :param build_infos: build infos to be sorted and de-duplicated</span>
<span class="sd">    :type build_infos: list[dict]</span>

<span class="sd">    :rtype: list[dict]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dedup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">build_infos</span> <span class="k">if</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">b</span> <span class="k">for</span> <span class="n">_bid</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">iteritems</span><span class="p">(</span><span class="n">dedup</span><span class="p">))]</span></div>


<div class="viewcode-block" id="build_dedup"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.build_dedup">[docs]</a><span class="k">def</span> <span class="nf">build_dedup</span><span class="p">(</span><span class="n">build_infos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a sequence of build info dictionaries, return a de-duplicated</span>
<span class="sd">    list of same, with order preserved.</span>

<span class="sd">    :param build_infos: build infos to be de-duplicated.</span>
<span class="sd">    :type build_infos: list[dict]</span>

<span class="sd">    :rtype: list[dict]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dedup</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">build_infos</span> <span class="k">if</span> <span class="n">b</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itervalues</span><span class="p">(</span><span class="n">dedup</span><span class="p">))</span></div>


<div class="viewcode-block" id="iter_bulk_tag_builds"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.iter_bulk_tag_builds">[docs]</a><span class="k">def</span> <span class="nf">iter_bulk_tag_builds</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tagid</span><span class="p">,</span> <span class="n">build_infos</span><span class="p">,</span>
                         <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                         <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tags a large number of builds using multicall invocations of</span>
<span class="sd">    tagBuildBypass. Builds are specified by build info dicts.</span>

<span class="sd">    yields lists of tuples containing a build info dict and the result</span>
<span class="sd">    of the tagBuildBypass call for that build. This gives the caller a</span>
<span class="sd">    chance to record the results of each multicall, and to present</span>
<span class="sd">    feedback to a user to indicate that the operations are continuing.</span>

<span class="sd">    :param tagid: Destination tag&#39;s ID</span>

<span class="sd">    :type tagid: int</span>

<span class="sd">    :param build_infos: Build infos to be tagged</span>

<span class="sd">    :type build_infos: list[dict]</span>

<span class="sd">    :param force: Force tagging. Re-tags if necessary, bypasses</span>
<span class="sd">        policy. Default, False</span>

<span class="sd">    :type force: bool, optional</span>

<span class="sd">    :param notify: Send tagging notifications. Default, False</span>

<span class="sd">    :type notify: bool, optional</span>

<span class="sd">    :param size: Count of tagging operations to perform in a single</span>
<span class="sd">        multicall. Default, 100</span>

<span class="sd">    :type size: int, optional</span>

<span class="sd">    :param strict: Raise an exception and discontinue execution at the</span>
<span class="sd">        first error. Default, False</span>

<span class="sd">    :type strict: bool, optional</span>

<span class="sd">    :rtype: Generator[list[tuple]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">build_chunk</span> <span class="ow">in</span> <span class="n">chunkseq</span><span class="p">(</span><span class="n">build_infos</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>
        <span class="n">session</span><span class="o">.</span><span class="n">multicall</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="n">build_chunk</span><span class="p">:</span>
            <span class="n">session</span><span class="o">.</span><span class="n">tagBuildBypass</span><span class="p">(</span><span class="n">tagid</span><span class="p">,</span> <span class="n">build</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">force</span><span class="p">,</span> <span class="n">notify</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">multiCall</span><span class="p">(</span><span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
        <span class="k">yield</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">build_chunk</span><span class="p">,</span> <span class="n">results</span><span class="p">))</span></div>


<div class="viewcode-block" id="bulk_tag_builds"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.bulk_tag_builds">[docs]</a><span class="k">def</span> <span class="nf">bulk_tag_builds</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tagname</span><span class="p">,</span> <span class="n">build_infos</span><span class="p">,</span>
                    <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param tagid: Destination tag&#39;s ID</span>

<span class="sd">    :type tagid: int</span>

<span class="sd">    :param build_infos: Build infos to be tagged</span>

<span class="sd">    :type build_infos: list[dict]</span>

<span class="sd">    :param force: Force tagging. Re-tags if necessary, bypasses</span>
<span class="sd">      policy. Default, False</span>

<span class="sd">    :type force: bool, optional</span>

<span class="sd">    :param notify: Send tagging notifications. Default, False</span>

<span class="sd">    :type notify: bool, optional</span>

<span class="sd">    :param size: Count of tagging operations to perform in a single</span>
<span class="sd">      multicall. Default, 100</span>

<span class="sd">    :type size: int, optional</span>

<span class="sd">    :param strict: Raise an exception and discontinue execution at the</span>
<span class="sd">      first error. Default, False</span>

<span class="sd">    :type strict: bool, optional</span>

<span class="sd">    :rtype: list[tuple]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">done</span> <span class="ow">in</span> <span class="n">iter_bulk_tag_builds</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tagname</span><span class="p">,</span> <span class="n">build_infos</span><span class="p">,</span>
                                     <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="n">notify</span><span class="p">,</span>
                                     <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">):</span>
        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">done</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="bulk_tag_nvrs"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.bulk_tag_nvrs">[docs]</a><span class="k">def</span> <span class="nf">bulk_tag_nvrs</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tagname</span><span class="p">,</span> <span class="n">nvrs</span><span class="p">,</span>
                  <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                  <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Tags a large number of builds using multicall invocations of</span>
<span class="sd">    tagBuildBypass.</span>

<span class="sd">    The entire list of NVRs is validated first, checking that such</span>
<span class="sd">    a build exists. If strict is True then a missing build will cause a</span>
<span class="sd">    NoSuchBuild exception to be raised. If strict is False, then missing</span>
<span class="sd">    builds will be omitted from the tagging operation.</span>

<span class="sd">    The list of builds is de-duplicated, preserving order of the first</span>
<span class="sd">    instance found in the list of NVRs.</span>

<span class="sd">    Returns a list of tuples, pairing build info dicts with the result of</span>
<span class="sd">    a tagBuildBypass call for that build.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">builds</span> <span class="o">=</span> <span class="n">bulk_load_builds</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">unique</span><span class="p">(</span><span class="n">nvrs</span><span class="p">),</span> <span class="n">err</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span>
    <span class="n">builds</span> <span class="o">=</span> <span class="n">build_dedup</span><span class="p">(</span><span class="n">itervalues</span><span class="p">(</span><span class="n">builds</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">bulk_tag_builds</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tagname</span><span class="p">,</span> <span class="n">builds</span><span class="p">,</span>
                           <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">,</span> <span class="n">notify</span><span class="o">=</span><span class="n">notify</span><span class="p">,</span>
                           <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="n">strict</span><span class="p">)</span></div>


<div class="viewcode-block" id="decorate_build_archive_data"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.decorate_build_archive_data">[docs]</a><span class="k">def</span> <span class="nf">decorate_build_archive_data</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">build_infos</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Augments a list of build_info dicts with four new keys:</span>

<span class="sd">    * archive_cg_ids is a set of content generator IDs for each</span>
<span class="sd">      archive of the build</span>

<span class="sd">    * archive_cg_names is a set of content generator names for each</span>
<span class="sd">      archive of the build</span>

<span class="sd">    * archive_btype_ids is a set of btype IDs for each archive of the</span>
<span class="sd">      build</span>

<span class="sd">    * archive_btype_names is a set of btype names for each archive of</span>
<span class="sd">      the build</span>

<span class="sd">    :param build_infos: list of build infos to decorate and return</span>
<span class="sd">    :type build_infos: list[dict]</span>

<span class="sd">    :rtype: list[dict]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># convert build_infos into an id:info dict</span>
    <span class="n">builds</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">b</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="n">b</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">build_infos</span><span class="p">)</span>

    <span class="c1"># multicall to fetch the artifacts for all build IDs</span>
    <span class="n">archives</span> <span class="o">=</span> <span class="n">bulk_load_build_archives</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">builds</span><span class="p">))</span>

    <span class="c1"># gather all the buildroot IDs</span>
    <span class="n">root_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">archive_list</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="n">archives</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">archive_list</span><span class="p">:</span>
            <span class="n">broot_id</span> <span class="o">=</span> <span class="n">archive</span><span class="p">[</span><span class="s2">&quot;buildroot_id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">broot_id</span><span class="p">:</span>
                <span class="c1"># do NOT allow None or 0</span>
                <span class="n">root_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">broot_id</span><span class="p">)</span>

    <span class="c1"># multicall to fetch all the buildroots</span>
    <span class="n">buildroots</span> <span class="o">=</span> <span class="n">bulk_load_buildroots</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">root_ids</span><span class="p">))</span>

    <span class="c1"># gather the cg_id and cg_name from each buildroot, and associate</span>
    <span class="c1"># it back with the original build info</span>
    <span class="k">for</span> <span class="n">build_id</span><span class="p">,</span> <span class="n">archive_list</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">archives</span><span class="p">):</span>

        <span class="n">bld</span> <span class="o">=</span> <span class="n">builds</span><span class="p">[</span><span class="n">build_id</span><span class="p">]</span>
        <span class="n">bld</span><span class="p">[</span><span class="s2">&quot;archive_cg_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cg_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">bld</span><span class="p">[</span><span class="s2">&quot;archive_cg_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cg_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">bld</span><span class="p">[</span><span class="s2">&quot;archive_btype_ids&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">btype_ids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">bld</span><span class="p">[</span><span class="s2">&quot;archive_btype_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">btype_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">archive</span> <span class="ow">in</span> <span class="n">archive_list</span><span class="p">:</span>
            <span class="n">btype_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">archive</span><span class="p">[</span><span class="s2">&quot;btype_id&quot;</span><span class="p">])</span>
            <span class="n">btype_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">archive</span><span class="p">[</span><span class="s2">&quot;btype&quot;</span><span class="p">])</span>

            <span class="n">broot_id</span> <span class="o">=</span> <span class="n">archive</span><span class="p">[</span><span class="s2">&quot;buildroot_id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">broot_id</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">broot</span> <span class="o">=</span> <span class="n">buildroots</span><span class="p">[</span><span class="n">broot_id</span><span class="p">]</span>

            <span class="n">cg_id</span> <span class="o">=</span> <span class="n">broot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cg_id&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cg_id</span><span class="p">:</span>
                <span class="n">cg_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cg_id</span><span class="p">)</span>

            <span class="n">cg_name</span> <span class="o">=</span> <span class="n">broot</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cg_name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cg_name</span><span class="p">:</span>
                <span class="n">cg_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cg_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">build_infos</span></div>


<div class="viewcode-block" id="filter_imported"><a class="viewcode-back" href="../../../kojismokydingo/#kojismokydingo.builds.filter_imported">[docs]</a><span class="k">def</span> <span class="nf">filter_imported</span><span class="p">(</span><span class="n">build_infos</span><span class="p">,</span> <span class="n">negate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">by_cg</span><span class="o">=</span><span class="p">()):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a sequence of build info dicts, return those which are</span>
<span class="sd">    imports.</span>

<span class="sd">    if negate is True, then behavior is flipped and only non-imports</span>
<span class="sd">    are emitted (and the by_cg parameter is ignored)</span>

<span class="sd">    If by_cg is not specified, then only non CG imports are emitted.</span>
<span class="sd">    If by_cg is specified, then emit only those imports which are from</span>
<span class="sd">    a content generator in that set (or any content generators if</span>
<span class="sd">    &#39;any&#39; is in the by_cg list).</span>

<span class="sd">    build_infos may have been decorated by the decorate_build_cg_list</span>
<span class="sd">    function. This provides an accurate listing of the content</span>
<span class="sd">    generators which have been used to import the build (if any). In</span>
<span class="sd">    the event that they have not been thus decorated, the cg filtering</span>
<span class="sd">    will rely on the cg_name setting on the build itself, which will</span>
<span class="sd">    only have been provided if the content generator reserved the</span>
<span class="sd">    build ahead of time.</span>

<span class="sd">    :param build_infos: build infos to filter through</span>
<span class="sd">    :type build_infos: list[dict]</span>

<span class="sd">    :param negate: whether to negate the imported test, Default False</span>
<span class="sd">    :type negate: bool, optional</span>

<span class="sd">    :param by_cg: Content generator names to filter for</span>
<span class="sd">    :type by_cg: list[str], optional</span>

<span class="sd">    :rtype: list[dict]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">by_cg</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">by_cg</span><span class="p">)</span>
    <span class="n">any_cg</span> <span class="o">=</span> <span class="s2">&quot;any&quot;</span> <span class="ow">in</span> <span class="n">by_cg</span>
    <span class="n">disjoint</span> <span class="o">=</span> <span class="n">by_cg</span><span class="o">.</span><span class="n">isdisjoint</span>

    <span class="n">found</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">build</span> <span class="ow">in</span> <span class="n">build_infos</span><span class="p">:</span>

        <span class="c1"># either get the decorated archive cg names, or start a fresh</span>
        <span class="c1"># one based on the possible cg_name associated with this build</span>
        <span class="n">build_cgs</span> <span class="o">=</span> <span class="n">build</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;archive_cg_names&quot;</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="n">cg_name</span> <span class="o">=</span> <span class="n">build</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cg_name&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cg_name</span><span class="p">:</span>
            <span class="n">build_cgs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cg_name</span><span class="p">)</span>

        <span class="n">is_import</span> <span class="o">=</span> <span class="n">build</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;task_id&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">negate</span><span class="p">:</span>
            <span class="c1"># looking for non-imports, regardless of CG or not</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_import</span><span class="p">:</span>
                <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">is_import</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">build_cgs</span><span class="p">:</span>
                <span class="c1"># this is a CG import</span>
                <span class="k">if</span> <span class="n">any_cg</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">disjoint</span><span class="p">(</span><span class="n">build_cgs</span><span class="p">):</span>
                    <span class="c1"># and we wanted either this specific one or any</span>
                    <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># this is not a CG import</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">by_cg</span><span class="p">:</span>
                    <span class="c1"># and we didn&#39;t want it to be</span>
                    <span class="n">found</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">found</span></div>


<span class="c1">#</span>
<span class="c1"># The end.</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex/" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex/" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../">kojismokydingo 0.9.0 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../" >Module code</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="../" >kojismokydingo</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Christopher O&#39;Brien.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.1.2.
    </div>
  </body>
</html>